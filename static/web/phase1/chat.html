<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•æ¬¡é—®ç­” - LLM Prompt ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css">
    <style>
        /* Chat specific styles */
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
            }
        }

        .chat-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message-box.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .token-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        .rating-section {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #fff3cd;
            border-radius: 8px;
            margin-top: 12px;
        }

        .rating-section.hidden {
            display: none;
        }

        .star-rating {
            display: flex;
            gap: 4px;
        }

        .star {
            font-size: 28px;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.filled {
            color: #ffd700;
        }

        .star.empty {
            color: #ddd;
        }

        .history-item {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-prompt {
            font-weight: 600;
            color: #667eea;
        }

        .history-date {
            font-size: 12px;
            color: #999;
        }

        .history-question {
            color: #555;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-tokens {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .prompt-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e7f3ff;
            color: #0066cc;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ’¬ å•æ¬¡é—®ç­”</h1>
            <div class="nav">
                <a href="index.html">Promptç®¡ç†</a>
                <a href="chat.html" class="active">å•æ¬¡é—®ç­”</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- é—®ç­”åŒºåŸŸ -->
        <div class="chat-container">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
            <div class="chat-section">
                <div class="card">
                    <h2 class="card-title">ğŸ¯ å‘èµ·é—®ç­”</h2>
                    <form id="chatForm">
                        <div class="form-group">
                            <label for="promptSelect">é€‰æ‹© Prompt (å¯é€‰)</label>
                            <select id="promptSelect">
                                <option value="0">ä¸ä½¿ç”¨ Prompt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userQuestion">æ‚¨çš„é—®é¢˜</label>
                            <textarea id="userQuestion" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." required></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                å‘é€é—®é¢˜
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearChat()">
                                æ¸…ç©º
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå›å¤åŒº -->
            <div class="chat-section">
                <div class="card">
                    <h2 class="card-title">ğŸ¤– AI å›å¤</h2>
                    <div id="assistantReply" class="message-box empty">
                        ç­‰å¾…æ‚¨çš„é—®é¢˜...
                    </div>

                    <!-- Tokenç»Ÿè®¡ -->
                    <div id="tokenStats" class="token-stats" style="display: none;">
                        <div class="stat-item">
                            <div class="stat-label">Prompt Tokens</div>
                            <div class="stat-value" id="promptTokens">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Completion Tokens</div>
                            <div class="stat-value" id="completionTokens">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Total Tokens</div>
                            <div class="stat-value" id="totalTokens">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å“åº”å»¶è¿Ÿ</div>
                            <div class="stat-value" id="latency">-</div>
                        </div>
                    </div>

                    <!-- å¿«æ·è¯„åˆ† -->
                    <div id="ratingSection" class="rating-section hidden">
                        <span>å¯¹æœ¬æ¬¡å›ç­”è¯„åˆ†ï¼š</span>
                        <div class="star-rating" id="starRating">
                            <span class="star empty" onclick="rate(1)">â˜…</span>
                            <span class="star empty" onclick="rate(2)">â˜…</span>
                            <span class="star empty" onclick="rate(3)">â˜…</span>
                            <span class="star empty" onclick="rate(4)">â˜…</span>
                            <span class="star empty" onclick="rate(5)">â˜…</span>
                        </div>
                        <button class="btn btn-success" onclick="submitQuickRating()">æäº¤è¯„åˆ†</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¹è¯å†å² -->
        <div class="card">
            <h2 class="card-title">ğŸ“œ å¯¹è¯å†å²</h2>
            <div id="historyList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="pagination">
                <button class="btn btn-secondary" id="prevPage">ä¸Šä¸€é¡µ</button>
                <span id="pageInfo">ç¬¬ 1 é¡µ</span>
                <button class="btn btn-secondary" id="nextPage">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <!-- å¯¹è¯è¯¦æƒ…Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ’¬ å¯¹è¯è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Toasté€šçŸ¥ -->
    <div id="toast" class="toast"></div>

    <script src="common.js"></script>
    <script>
        // é¡µé¢çŠ¶æ€
        let currentConversationId = null;
        let currentPromptId = null;
        let currentRating = 0;
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadPromptList();
            loadConversationHistory();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // é—®ç­”è¡¨å•æäº¤
            document.getElementById('chatForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitChat();
            });

            // åˆ†é¡µæŒ‰é’®
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadConversationHistory();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadConversationHistory();
                }
            });
        }

        // åŠ è½½Promptåˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
        async function loadPromptList() {
            try {
                const result = await apiGet('/prompt/?page=1&page_size=100');

                if (result.ok && result.data.list) {
                    const select = document.getElementById('promptSelect');
                    result.data.list.forEach(prompt => {
                        const option = document.createElement('option');
                        option.value = prompt.id;
                        option.textContent = prompt.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load prompts:', error);
            }
        }

        // æäº¤é—®ç­”
        async function submitChat() {
            const promptId = parseInt(document.getElementById('promptSelect').value);
            const question = document.getElementById('userQuestion').value.trim();

            if (!question) {
                showToast('è¯·è¾“å…¥é—®é¢˜', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> æ€è€ƒä¸­...';

            // éšè—è¯„åˆ†åŒºåŸŸ
            document.getElementById('ratingSection').classList.add('hidden');
            document.getElementById('tokenStats').style.display = 'none';

            // æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
            const replyBox = document.getElementById('assistantReply');
            replyBox.className = 'message-box empty';
            replyBox.textContent = 'ğŸ¤” AI æ­£åœ¨æ€è€ƒ...';

            try {
                const result = await apiPost('/conversation/chat', {
                    prompt_id: promptId,
                    question: question,
                    model: 'kimi-k2.5'
                });

                if (result.ok) {
                    const data = result.data;

                    // æ˜¾ç¤ºå›å¤
                    replyBox.className = 'message-box';
                    replyBox.textContent = data.reply;

                    // æ˜¾ç¤ºTokenç»Ÿè®¡
                    document.getElementById('promptTokens').textContent = formatTokenCount(data.prompt_tokens);
                    document.getElementById('completionTokens').textContent = formatTokenCount(data.completion_tokens);
                    document.getElementById('totalTokens').textContent = formatTokenCount(data.total_tokens);
                    document.getElementById('latency').textContent = formatLatency(data.latency);
                    document.getElementById('tokenStats').style.display = 'grid';

                    // æ˜¾ç¤ºè¯„åˆ†åŒºåŸŸï¼ˆä»…å½“ä½¿ç”¨äº†Promptæ—¶ï¼‰
                    if (promptId > 0) {
                        currentConversationId = data.conversation_id;
                        currentPromptId = promptId;
                        currentRating = 0;
                        resetStars();
                        document.getElementById('ratingSection').classList.remove('hidden');
                    }

                    // åˆ·æ–°å†å²è®°å½•
                    loadConversationHistory();

                    showToast('é—®ç­”å®Œæˆ', 'success');
                } else {
                    replyBox.className = 'message-box';
                    replyBox.textContent = 'âŒ ' + (result.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    showToast(result.message || 'è¯·æ±‚å¤±è´¥', 'error');
                }
            } catch (error) {
                replyBox.className = 'message-box';
                replyBox.textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message;
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            document.getElementById('userQuestion').value = '';
            document.getElementById('assistantReply').className = 'message-box empty';
            document.getElementById('assistantReply').textContent = 'ç­‰å¾…æ‚¨çš„é—®é¢˜...';
            document.getElementById('tokenStats').style.display = 'none';
            document.getElementById('ratingSection').classList.add('hidden');
            currentConversationId = null;
            currentPromptId = null;
            currentRating = 0;
        }

        // æ˜Ÿçº§è¯„åˆ†
        function rate(score) {
            currentRating = score * 2; // è½¬æ¢ä¸º0-10åˆ†åˆ¶
            updateStars(score);
        }

        function updateStars(score) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < score) {
                    star.classList.remove('empty');
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                    star.classList.add('empty');
                }
            });
        }

        function resetStars() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.classList.remove('filled');
                star.classList.add('empty');
            });
        }

        // æäº¤å¿«æ·è¯„åˆ†
        async function submitQuickRating() {
            if (currentRating === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¯„åˆ†', 'error');
                return;
            }

            if (!currentPromptId) {
                showToast('æ— æ³•æäº¤è¯„åˆ†ï¼šæœªä½¿ç”¨Prompt', 'error');
                return;
            }

            try {
                const result = await apiPost(`/prompt/${currentPromptId}/rating`, {
                    scene_name: 'å•æ¬¡é—®ç­”',
                    score: currentRating
                });

                if (result.ok) {
                    showToast('è¯„åˆ†æäº¤æˆåŠŸ', 'success');
                    document.getElementById('ratingSection').classList.add('hidden');
                } else {
                    showToast(result.message || 'è¯„åˆ†æäº¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // åŠ è½½å¯¹è¯å†å²
        async function loadConversationHistory() {
            try {
                const result = await apiGet(`/conversation/?page=${currentPage}&page_size=${pageSize}`);

                if (result.ok) {
                    renderHistory(result.data);
                    updatePagination(result.data);
                } else {
                    showToast(result.message || 'åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory(data) {
            const historyList = document.getElementById('historyList');

            if (!data.list || data.list.length === 0) {
                historyList.innerHTML = `
                    <div class="loading">
                        ğŸ“­ æš‚æ— å¯¹è¯è®°å½•
                    </div>
                `;
                return;
            }

            historyList.innerHTML = data.list.map(conv => {
                const promptName = conv.prompt ? conv.prompt.name : 'æ— Prompt';
                return `
                    <div class="history-item" onclick="viewConversation(${conv.id})">
                        <div class="history-header">
                            <div class="history-prompt">${escapeHtml(promptName)}</div>
                            <div class="history-date">${formatDate(conv.created_at)}</div>
                        </div>
                        <div class="history-question">
                            <strong>é—®ï¼š</strong>${escapeHtml(conv.user_question)}
                        </div>
                        <div class="history-tokens">
                            <span>ğŸ“Š ${formatTokenCount(conv.total_tokens)} tokens</span>
                            <span>âš¡ ${formatLatency(conv.latency)}</span>
                            <span>ğŸ¤– ${escapeHtml(conv.model)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updatePagination(data) {
            totalPages = Math.ceil(data.total / pageSize) || 1;
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ (å…± ${data.total} æ¡)`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        // æŸ¥çœ‹å¯¹è¯è¯¦æƒ…
        async function viewConversation(id) {
            try {
                const result = await apiGet(`/conversation/${id}`);

                if (result.ok) {
                    const conv = result.data;
                    const promptInfo = conv.prompt ?
                        `<span class="prompt-badge">${escapeHtml(conv.prompt.name)}</span>` :
                        '<span class="prompt-badge" style="background: #f0f0f0; color: #666;">æ— Prompt</span>';

                    document.getElementById('detailContent').innerHTML = `
                        <div class="form-group">
                            <label>ä½¿ç”¨çš„ Prompt</label>
                            <p>${promptInfo}</p>
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·é—®é¢˜</label>
                            <div class="message-box">${escapeHtml(conv.user_question)}</div>
                        </div>
                        <div class="form-group">
                            <label>AI å›å¤</label>
                            <div class="message-box">${escapeHtml(conv.assistant_reply)}</div>
                        </div>
                        <div class="form-group">
                            <label>Token ç»Ÿè®¡</label>
                            <div class="token-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Prompt Tokens</div>
                                    <div class="stat-value">${formatTokenCount(conv.prompt_tokens)}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Completion Tokens</div>
                                    <div class="stat-value">${formatTokenCount(conv.completion_tokens)}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Total Tokens</div>
                                    <div class="stat-value">${formatTokenCount(conv.total_tokens)}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">å“åº”å»¶è¿Ÿ</div>
                                    <div class="stat-value">${formatLatency(conv.latency)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å…¶ä»–ä¿¡æ¯</label>
                            <p><strong>æ¨¡å‹ï¼š</strong>${escapeHtml(conv.model)}</p>
                            <p><strong>æ—¶é—´ï¼š</strong>${formatDate(conv.created_at)}</p>
                        </div>
                    `;

                    document.getElementById('detailModal').classList.add('active');
                } else {
                    showToast(result.message || 'åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // å…³é—­è¯¦æƒ…Modal
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }
    </script>
</body>
</html>
