<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•æ¬¡é—®ç­” - LLM Prompt ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css">
    <style>
        /* Chat specific styles */
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
            height: 800px;
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .chat-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 100%;
        }

        .chat-section .card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #chatForm {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 16px;
        }

        #chatForm .form-group:last-of-type {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #chatForm textarea {
            flex: 1;
            resize: none;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .message-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            flex: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message-box.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .token-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
            flex-shrink: 0;
        }

        .token-stats.compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            flex-shrink: 0;
        }

        .token-stat {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        /* è¯„åˆ†åŒºåŸŸæ ·å¼ - å¯¹è¯å®Œæˆåæ˜¾ç¤º */
        .rating-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #fff3cd;
            border-radius: 8px;
            margin-top: 12px;
            flex-shrink: 0;
        }

        .rating-field {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* åœºæ™¯è¾“å…¥æ¡†åŠè‡ªåŠ¨å®Œæˆæ ·å¼ */
        .scene-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .scene-input-wrapper input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            width: 150px;
        }

        .scene-input-wrapper input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .scene-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .scene-suggestions.show {
            display: block;
        }

        .scene-suggestion-item {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 13px;
        }

        .scene-suggestion-item:hover {
            background: #f0f4ff;
        }

        /* åˆ†æ•°è¾“å…¥æ ·å¼ - ç»Ÿä¸€é£æ ¼ */
        .score-input-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-input-wrapper input[type="number"] {
            width: 60px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }

        .score-input-wrapper input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .score-label {
            font-size: 12px;
            color: #666;
        }

        /* æ˜Ÿçº§è¯„åˆ†æ ·å¼ */
        .star-rating {
            display: flex;
            gap: 4px;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
            position: relative;
            display: inline-block;
            line-height: 1;
        }

        .star:hover {
            transform: scale(1.1);
        }

        .star-base {
            color: #ddd;
        }

        .star-fill {
            color: #ffd700;
            position: absolute;
            left: 0;
            top: 0;
            width: 0;
            overflow: hidden;
        }

        .rating-value {
            font-size: 12px;
            color: #555;
            min-width: 50px;
        }

        /* å¯¹è¯å†å²ä¸­çš„traceIdæ ·å¼ */
        .history-trace-id {
            font-size: 11px;
            color: #888;
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* è¯„åˆ†æ˜ç»†è¡¨æ ¼æ ·å¼ */
        .rating-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rating-table th,
        .rating-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
            font-size: 13px;
        }

        .rating-table th {
            background: #f8f9fa;
            color: #666;
        }

        /* è¯„åˆ†æ˜ç»†ç­›é€‰åŒºåŸŸæ ·å¼ */
        .rating-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 16px;
        }

        .rating-filter-row .form-group {
            margin-bottom: 0;
            min-width: 120px;
        }

        .rating-filter-row .form-group input,
        .rating-filter-row .form-group select {
            padding: 8px 12px;
            font-size: 13px;
        }

        /* æŸ¥çœ‹å¯¹è¯æŒ‰é’®æ ·å¼ */
        .btn-view-conv {
            padding: 4px 8px;
            font-size: 11px;
            background: #e7f3ff;
            color: #0066cc;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-view-conv:hover {
            background: #cce5ff;
        }

        .history-item {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-prompt {
            font-weight: 600;
            color: #667eea;
        }

        .history-date {
            font-size: 12px;
            color: #999;
        }

        .history-question {
            color: #555;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-tokens {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .prompt-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e7f3ff;
            color: #0066cc;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ’¬ å•æ¬¡é—®ç­”</h1>
            <div class="nav">
                <a href="index.html">Promptç®¡ç†</a>
                <a href="chat.html" class="active">å•æ¬¡é—®ç­”</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- é—®ç­”åŒºåŸŸ -->
        <div class="chat-container">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒº -->
            <div class="chat-section">
                <div class="card">
                    <h2 class="card-title">ğŸ¯ å‘èµ·é—®ç­”</h2>
                    <form id="chatForm">
                        <div class="form-group">
                            <label for="promptSelect">é€‰æ‹© Prompt (å¯é€‰)</label>
                            <select id="promptSelect">
                                <option value="0">ä¸ä½¿ç”¨ Prompt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userQuestion">æ‚¨çš„é—®é¢˜</label>
                            <textarea id="userQuestion" rows="18" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." required></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                å‘é€é—®é¢˜
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearChat()">
                                æ¸…ç©º
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå›å¤åŒº -->
            <div class="chat-section">
                <div class="card">
                    <h2 class="card-title">ğŸ¤– AI å›å¤</h2>
                    <div id="assistantReply" class="message-box empty">ç­‰å¾…æ‚¨çš„é—®é¢˜...</div>

                    <!-- Tokenç»Ÿè®¡ -->
                    <div id="tokenStats" class="token-stats compact" style="display: none;">
                        <span class="token-stat">Prompt: <span id="promptTokens">-</span></span>
                        <span class="token-stat">Completion: <span id="completionTokens">-</span></span>
                        <span class="token-stat">Total: <span id="totalTokens">-</span></span>
                        <span class="token-stat">å»¶è¿Ÿ: <span id="latency">-</span></span>
                    </div>

                    <!-- å¿«æ·è¯„åˆ†åŒºåŸŸ - å¯¹è¯å®Œæˆåæ˜¾ç¤º -->
                    <div id="ratingSection" class="rating-section hidden">
                        <span>å¯¹æœ¬æ¬¡å›ç­”è¯„åˆ†ï¼š</span>
                        <!-- åœºæ™¯è¾“å…¥ - æ”¯æŒè‡ªåŠ¨å®Œæˆ -->
                        <div class="rating-field">
                            <label for="ratingSceneName">åœºæ™¯</label>
                            <div class="scene-input-wrapper">
                                <input type="text" id="ratingSceneName" placeholder="å¦‚ï¼šé—®ç­”å¯¹è¯"
                                       autocomplete="off" onfocus="showSceneSuggestions()" oninput="filterSceneSuggestions()">
                                <div class="scene-suggestions" id="sceneSuggestions"></div>
                            </div>
                        </div>
                        <!-- æ˜Ÿçº§è¯„åˆ† -->
                        <div class="star-rating" id="starRating">
                            <span class="star" onclick="handleStarClick(event, 1)">
                                <span class="star-base">â˜…</span>
                                <span class="star-fill">â˜…</span>
                            </span>
                            <span class="star" onclick="handleStarClick(event, 2)">
                                <span class="star-base">â˜…</span>
                                <span class="star-fill">â˜…</span>
                            </span>
                            <span class="star" onclick="handleStarClick(event, 3)">
                                <span class="star-base">â˜…</span>
                                <span class="star-fill">â˜…</span>
                            </span>
                            <span class="star" onclick="handleStarClick(event, 4)">
                                <span class="star-base">â˜…</span>
                                <span class="star-fill">â˜…</span>
                            </span>
                            <span class="star" onclick="handleStarClick(event, 5)">
                                <span class="star-base">â˜…</span>
                                <span class="star-fill">â˜…</span>
                            </span>
                        </div>
                        <!-- åˆ†æ•°è¾“å…¥æ¡† - å¯æ‰‹åŠ¨ç¼–è¾‘ -->
                        <div class="score-input-wrapper">
                            <label for="scoreInput" class="score-label">åˆ†æ•°ï¼š</label>
                            <input type="number" id="scoreInput" min="0" max="10" step="0.5" value="0"
                                   onchange="onScoreInputChange(this.value)" placeholder="0-10">
                            <span class="score-label">/ 10 åˆ†</span>
                        </div>
                        <button class="btn btn-success" onclick="submitQuickRating()">æäº¤è¯„åˆ†</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¹è¯å†å² -->
        <div class="card">
            <h2 class="card-title">ğŸ“œ å¯¹è¯å†å²</h2>
            <div id="historyList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="pagination">
                <button class="btn btn-secondary" id="prevPage">ä¸Šä¸€é¡µ</button>
                <span id="pageInfo">ç¬¬ 1 é¡µ</span>
                <button class="btn btn-secondary" id="nextPage">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>

        <!-- è¯„åˆ†æ˜ç»†æŸ¥è¯¢ -->
        <div class="card">
            <h2 class="card-title">ğŸ“‹ è¯„åˆ†æ˜ç»†æŸ¥è¯¢</h2>
            <div class="rating-filter-row">
                <div class="form-group">
                    <label for="ratingPromptSelect">Prompt</label>
                    <select id="ratingPromptSelect">
                        <option value="">å…¨éƒ¨Prompt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ratingSceneSelect">åœºæ™¯åç§°</label>
                    <select id="ratingSceneSelect">
                        <option value="">å…¨éƒ¨åœºæ™¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ratingSceneFilter">åœºæ™¯(è‡ªå®šä¹‰)</label>
                    <input type="text" id="ratingSceneFilter" placeholder="æ‰‹åŠ¨è¾“å…¥">
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" type="button" id="ratingQueryBtn">æŸ¥è¯¢</button>
                    <button class="btn btn-secondary" type="button" id="ratingResetBtn">é‡ç½®</button>
                </div>
            </div>
            <div id="ratingList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="pagination">
                <button class="btn btn-secondary" id="ratingPrevPage">ä¸Šä¸€é¡µ</button>
                <span id="ratingPageInfo">ç¬¬ 1 é¡µ</span>
                <button class="btn btn-secondary" id="ratingNextPage">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <!-- å¯¹è¯è¯¦æƒ…Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ’¬ å¯¹è¯è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Toasté€šçŸ¥ -->
    <div id="toast" class="toast"></div>

    <script src="common.js"></script>
    <script>
        // é¡µé¢çŠ¶æ€
        let currentConversationId = null;
        let currentPromptId = null;
        let currentStarRating = 0;
        let currentRating = 0;  // 0-10åˆ†æ•°ï¼Œä¸éœ€è¦x2è½¬æ¢
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let ratingPage = 1;
        let ratingPageSize = 10;
        let ratingTotalPages = 1;
        let sceneNameList = [];  // åœºæ™¯åç§°åˆ—è¡¨ï¼Œç”¨äºè‡ªåŠ¨å®Œæˆ

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadPromptList();
            loadSceneNameList();  // åŠ è½½åœºæ™¯åˆ—è¡¨ç”¨äºè‡ªåŠ¨å®Œæˆ
            loadConversationHistory();
            loadRatingList();
            setupEventListeners();
            setupSceneInputEvents();  // è®¾ç½®åœºæ™¯è¾“å…¥äº‹ä»¶
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // é—®ç­”è¡¨å•æäº¤
            document.getElementById('chatForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitChat();
            });

            // åˆ†é¡µæŒ‰é’®
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadConversationHistory();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadConversationHistory();
                }
            });

            document.getElementById('ratingQueryBtn').addEventListener('click', () => {
                ratingPage = 1;
                loadRatingList();
            });

            // é‡ç½®ç­›é€‰æ¡ä»¶æŒ‰é’®
            document.getElementById('ratingResetBtn').addEventListener('click', () => {
                document.getElementById('ratingPromptSelect').value = '';
                document.getElementById('ratingSceneSelect').value = '';
                document.getElementById('ratingSceneFilter').value = '';
                ratingPage = 1;
                loadRatingList();
            });

            document.getElementById('ratingPrevPage').addEventListener('click', () => {
                if (ratingPage > 1) {
                    ratingPage--;
                    loadRatingList();
                }
            });

            document.getElementById('ratingNextPage').addEventListener('click', () => {
                if (ratingPage < ratingTotalPages) {
                    ratingPage++;
                    loadRatingList();
                }
            });
        }

        // åŠ è½½Promptåˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
        async function loadPromptList() {
            try {
                const result = await apiGet('/prompt/?page=1&page_size=100');

                if (result.ok && result.data.list) {
                    const select = document.getElementById('promptSelect');
                    const ratingSelect = document.getElementById('ratingPromptSelect');
                    result.data.list.forEach(prompt => {
                        const option = document.createElement('option');
                        option.value = prompt.id;
                        option.textContent = prompt.name;
                        select.appendChild(option);

                        const ratingOption = document.createElement('option');
                        ratingOption.value = prompt.id;
                        ratingOption.textContent = prompt.name;
                        ratingSelect.appendChild(ratingOption);
                    });
                }
            } catch (error) {
                console.error('Failed to load prompts:', error);
            }
        }

        // æäº¤é—®ç­”
        async function submitChat() {
            const promptId = parseInt(document.getElementById('promptSelect').value);
            const question = document.getElementById('userQuestion').value.trim();

            if (!question) {
                showToast('è¯·è¾“å…¥é—®é¢˜', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> æ€è€ƒä¸­...';

            // éšè—è¯„åˆ†åŒºåŸŸ
            document.getElementById('ratingSection').classList.add('hidden');
            document.getElementById('tokenStats').style.display = 'none';

            // æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
            const replyBox = document.getElementById('assistantReply');
            replyBox.className = 'message-box empty';
            replyBox.textContent = 'ğŸ¤” AI æ­£åœ¨æ€è€ƒ...';

            try {
                const result = await apiPost('/conversation/chat', {
                    prompt_id: promptId,
                    question: question,
                    model: 'kimi-k2.5'
                });

                if (result.ok) {
                    const data = result.data;

                    // æ˜¾ç¤ºå›å¤
                    replyBox.className = 'message-box';
                    replyBox.textContent = data.reply;

                    // æ˜¾ç¤ºTokenç»Ÿè®¡
                    document.getElementById('promptTokens').textContent = formatTokenCount(data.prompt_tokens);
                    document.getElementById('completionTokens').textContent = formatTokenCount(data.completion_tokens);
                    document.getElementById('totalTokens').textContent = formatTokenCount(data.total_tokens);
                    document.getElementById('latency').textContent = formatLatency(data.latency);
                    document.getElementById('tokenStats').style.display = 'flex';

                    // æ˜¾ç¤ºè¯„åˆ†åŒºåŸŸï¼ˆä»…å½“ä½¿ç”¨äº†Promptæ—¶ï¼‰
                    if (promptId > 0) {
                        currentConversationId = data.conversation_id;
                        currentPromptId = promptId;
                        currentStarRating = 0;
                        currentRating = 0;
                        document.getElementById('ratingSceneName').value = '';
                        resetStars();
                        document.getElementById('ratingSection').classList.remove('hidden');
                    }

                    // åˆ·æ–°å†å²è®°å½•
                    loadConversationHistory();

                    showToast('é—®ç­”å®Œæˆ', 'success');
                } else {
                    replyBox.className = 'message-box';
                    replyBox.textContent = 'âŒ ' + (result.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    showToast(result.message || 'è¯·æ±‚å¤±è´¥', 'error');
                }
            } catch (error) {
                replyBox.className = 'message-box';
                replyBox.textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message;
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        /**
         * æ¸…ç©ºå¯¹è¯çŠ¶æ€
         */
        function clearChat() {
            document.getElementById('userQuestion').value = '';
            document.getElementById('assistantReply').className = 'message-box empty';
            document.getElementById('assistantReply').textContent = 'ç­‰å¾…æ‚¨çš„é—®é¢˜...';
            document.getElementById('tokenStats').style.display = 'none';
            document.getElementById('ratingSection').classList.add('hidden');
            document.getElementById('ratingSceneName').value = '';
            document.getElementById('scoreInput').value = '0';
            currentConversationId = null;
            currentPromptId = null;
            currentStarRating = 0;
            currentRating = 0;
            resetStars();
        }

        /**
         * å¤„ç†æ˜Ÿçº§ç‚¹å‡»äº‹ä»¶
         * @param {Event} event - ç‚¹å‡»äº‹ä»¶
         * @param {number} index - æ˜Ÿçº§ç´¢å¼• (1-5)
         */
        function handleStarClick(event, index) {
            const rect = event.currentTarget.getBoundingClientRect();
            const offsetX = event.clientX - rect.left;
            const isHalf = offsetX < rect.width / 2;
            // æ˜Ÿçº§è¯„åˆ† 1-5ï¼Œè½¬æ¢ä¸ºå®é™…åˆ†æ•° 2-10 (æ¯æ˜Ÿ2åˆ†)
            const starValue = index - (isHalf ? 0.5 : 0);
            const score = starValue * 2;  // ç›´æ¥ä½¿ç”¨0-10åˆ†
            setStarRating(starValue, score);
        }

        /**
         * è®¾ç½®æ˜Ÿçº§è¯„åˆ†
         * @param {number} starValue - æ˜Ÿçº§å€¼ (0-5)
         * @param {number} score - å®é™…åˆ†æ•° (0-10)
         */
        function setStarRating(starValue, score) {
            currentStarRating = starValue;
            currentRating = score;
            updateStars();
            // åŒæ­¥æ›´æ–°åˆ†æ•°è¾“å…¥æ¡†
            document.getElementById('scoreInput').value = score.toFixed(1);
        }

        /**
         * åˆ†æ•°è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
         * @param {string} value - è¾“å…¥çš„åˆ†æ•°å€¼
         */
        function onScoreInputChange(value) {
            let score = parseFloat(value);
            // éªŒè¯åˆ†æ•°èŒƒå›´
            if (isNaN(score) || score < 0) score = 0;
            if (score > 10) score = 10;
            // æ›´æ–°åˆ†æ•°è¾“å…¥æ¡†æ˜¾ç¤ºæ ‡å‡†å€¼
            document.getElementById('scoreInput').value = score.toFixed(1);
            // è®¡ç®—å¯¹åº”æ˜Ÿçº§å¹¶æ›´æ–°çŠ¶æ€
            currentStarRating = score / 2;
            currentRating = score;
            updateStars();
        }

        /**
         * æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
         */
        function updateStars() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                const fill = Math.min(Math.max(currentStarRating - index, 0), 1);
                const fillEl = star.querySelector('.star-fill');
                if (fillEl) {
                    fillEl.style.width = `${fill * 100}%`;
                }
            });
        }

        /**
         * é‡ç½®æ˜Ÿçº§è¯„åˆ†
         */
        function resetStars() {
            currentStarRating = 0;
            currentRating = 0;
            updateStars();
            document.getElementById('scoreInput').value = '0';
        }

        /**
         * æäº¤å¿«æ·è¯„åˆ†
         */
        async function submitQuickRating() {
            // éªŒè¯åˆ†æ•°
            const scoreInput = document.getElementById('scoreInput');
            const score = parseFloat(scoreInput.value);

            if (isNaN(score) || score < 0 || score > 10) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°(0-10)', 'error');
                return;
            }

            if (!currentPromptId) {
                showToast('æ— æ³•æäº¤è¯„åˆ†ï¼šæœªä½¿ç”¨Prompt', 'error');
                return;
            }

            const sceneName = document.getElementById('ratingSceneName').value.trim();
            if (!sceneName) {
                showToast('è¯·å¡«å†™åœºæ™¯åç§°', 'error');
                return;
            }

            try {
                const result = await apiPost(`/prompt/${currentPromptId}/rating`, {
                    scene_name: sceneName,
                    score: score,  // ç›´æ¥ä½¿ç”¨0-10åˆ†æ•°
                    conversation_id: currentConversationId
                });

                if (result.ok) {
                    showToast('è¯„åˆ†æäº¤æˆåŠŸ', 'success');
                    document.getElementById('ratingSection').classList.add('hidden');
                    // åˆ·æ–°åœºæ™¯åˆ—è¡¨å’Œè¯„åˆ†åˆ—è¡¨
                    loadSceneNameList();
                    loadRatingList();
                } else {
                    showToast(result.message || 'è¯„åˆ†æäº¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // åŠ è½½å¯¹è¯å†å²
        async function loadConversationHistory() {
            try {
                const result = await apiGet(`/conversation/?page=${currentPage}&page_size=${pageSize}`);

                if (result.ok) {
                    renderHistory(result.data);
                    updatePagination(result.data);
                } else {
                    showToast(result.message || 'åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        /**
         * æ¸²æŸ“è¯„åˆ†æ˜ç»†è¡¨æ ¼
         * @param {Array} list - è¯„åˆ†åˆ—è¡¨æ•°æ®
         * @param {string} containerId - å®¹å™¨å…ƒç´ ID
         */
        function renderRatingTable(list, containerId) {
            const container = document.getElementById(containerId);
            if (!list || list.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— è¯„åˆ†è®°å½•</div>';
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table class="rating-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Prompt</th>
                                <th>åœºæ™¯</th>
                                <th>è¯„åˆ†</th>
                                <th>å¯¹è¯</th>
                                <th>æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map(item => `
                                <tr>
                                    <td>${item.id}</td>
                                    <td>${escapeHtml(item.prompt_name || '-')}</td>
                                    <td>${escapeHtml(item.scene_name)}</td>
                                    <td>${item.score.toFixed(1)}</td>
                                    <td>
                                        ${item.conversation_id ?
                                            `<button class="btn-view-conv" onclick="viewConversation(${item.conversation_id})" title="æŸ¥çœ‹å¯¹è¯è¯¦æƒ…">
                                                #${item.conversation_id} ğŸ‘ï¸
                                            </button>` :
                                            '-'}
                                    </td>
                                    <td>${formatDate(item.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        /**
         * åŠ è½½è¯„åˆ†æ˜ç»†åˆ—è¡¨
         */
        async function loadRatingList() {
            const promptId = document.getElementById('ratingPromptSelect').value;
            // ä¼˜å…ˆä½¿ç”¨ä¸‹æ‹‰é€‰æ‹©çš„åœºæ™¯ï¼Œå…¶æ¬¡ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„åœºæ™¯
            const sceneSelect = document.getElementById('ratingSceneSelect').value;
            const sceneFilter = document.getElementById('ratingSceneFilter').value.trim();
            const sceneName = sceneSelect || sceneFilter;

            const params = new URLSearchParams();
            params.set('page', ratingPage.toString());
            params.set('page_size', ratingPageSize.toString());
            if (promptId) {
                params.set('prompt_id', promptId);
            }
            if (sceneName) {
                params.set('scene_name', sceneName);
            }

            try {
                const result = await apiGet(`/prompt/rating/list?${params.toString()}`);
                if (result.ok) {
                    renderRatingTable(result.data.list, 'ratingList');
                    updateRatingPagination(result.data);
                } else {
                    showToast(result.message || 'åŠ è½½è¯„åˆ†æ˜ç»†å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        function updateRatingPagination(data) {
            ratingTotalPages = Math.ceil(data.total / ratingPageSize) || 1;
            document.getElementById('ratingPageInfo').textContent = `ç¬¬ ${ratingPage} / ${ratingTotalPages} é¡µ (å…± ${data.total} æ¡)`;
            document.getElementById('ratingPrevPage').disabled = ratingPage <= 1;
            document.getElementById('ratingNextPage').disabled = ratingPage >= ratingTotalPages;
        }

        async function loadConversationRatings(conversationId, promptId) {
            const params = new URLSearchParams();
            params.set('page', '1');
            params.set('page_size', '10');
            params.set('conversation_id', conversationId.toString());
            if (promptId) {
                params.set('prompt_id', promptId.toString());
            }

            try {
                const result = await apiGet(`/prompt/rating/list?${params.toString()}`);
                if (result.ok) {
                    renderRatingTable(result.data.list, 'conversationRatingList');
                } else {
                    document.getElementById('conversationRatingList').innerHTML = '<div class="loading">è¯„åˆ†è®°å½•åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                document.getElementById('conversationRatingList').innerHTML = '<div class="loading">è¯„åˆ†è®°å½•åŠ è½½å¤±è´¥</div>';
            }
        }

        /**
         * æ¸²æŸ“å¯¹è¯å†å²åˆ—è¡¨
         * @param {Object} data - åˆ†é¡µæ•°æ®
         */
        function renderHistory(data) {
            const historyList = document.getElementById('historyList');

            if (!data.list || data.list.length === 0) {
                historyList.innerHTML = `
                    <div class="loading">
                        ğŸ“­ æš‚æ— å¯¹è¯è®°å½•
                    </div>
                `;
                return;
            }

            historyList.innerHTML = data.list.map(conv => {
                const promptName = conv.prompt ? conv.prompt.name : 'æ— Prompt';
                // æ˜¾ç¤ºtraceIdï¼Œå¦‚æœå­˜åœ¨çš„è¯
                const traceIdDisplay = conv.trace_id ?
                    `<span class="history-trace-id" title="Trace ID: ${escapeHtml(conv.trace_id)}">${escapeHtml(conv.trace_id.substring(0, 8))}...</span>` : '';
                return `
                    <div class="history-item" onclick="viewConversation(${conv.id})">
                        <div class="history-header">
                            <div class="history-prompt">${escapeHtml(promptName)}${traceIdDisplay}</div>
                            <div class="history-date">${formatDate(conv.created_at)}</div>
                        </div>
                        <div class="history-question">
                            <strong>é—®ï¼š</strong>${escapeHtml(conv.user_question)}
                        </div>
                        <div class="history-tokens">
                            <span>ğŸ“Š ${formatTokenCount(conv.total_tokens)} tokens</span>
                            <span>âš¡ ${formatLatency(conv.latency)}</span>
                            <span>ğŸ¤– ${escapeHtml(conv.model)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updatePagination(data) {
            totalPages = Math.ceil(data.total / pageSize) || 1;
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ (å…± ${data.total} æ¡)`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        /**
         * æŸ¥çœ‹å¯¹è¯è¯¦æƒ…
         * @param {number} id - å¯¹è¯ID
         */
        async function viewConversation(id) {
            try {
                const result = await apiGet(`/conversation/${id}`);

                if (result.ok) {
                    const conv = result.data;
                    const promptInfo = conv.prompt ?
                        `<span class="prompt-badge">${escapeHtml(conv.prompt.name)}</span>` :
                        '<span class="prompt-badge" style="background: #f0f0f0; color: #666;">æ— Prompt</span>';

                    // æ˜¾ç¤ºtraceIdä¿¡æ¯
                    const traceIdInfo = conv.trace_id ?
                        `<p><strong>Trace IDï¼š</strong><code style="background:#f0f0f0;padding:2px 6px;border-radius:4px;">${escapeHtml(conv.trace_id)}</code></p>` : '';

                    document.getElementById('detailContent').innerHTML = `
                        <div class="form-group">
                            <label>ä½¿ç”¨çš„ Prompt</label>
                            <p>${promptInfo}</p>
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·é—®é¢˜</label>
                            <div class="message-box">${escapeHtml(conv.user_question)}</div>
                        </div>
                        <div class="form-group">
                            <label>AI å›å¤</label>
                            <div class="message-box">${escapeHtml(conv.assistant_reply)}</div>
                        </div>
                        <div class="form-group">
                            <label>Token ç»Ÿè®¡</label>
                            <div class="token-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Prompt Tokens</div>
                                    <div class="stat-value">${formatTokenCount(conv.prompt_tokens)}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Completion Tokens</div>
                                    <div class="stat-value">${formatTokenCount(conv.completion_tokens)}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Total Tokens</div>
                                    <div class="stat-value">${formatTokenCount(conv.total_tokens)}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">å“åº”å»¶è¿Ÿ</div>
                                    <div class="stat-value">${formatLatency(conv.latency)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>è¯„åˆ†è®°å½•</label>
                            <div id="conversationRatingList"><div class="loading">åŠ è½½ä¸­...</div></div>
                        </div>
                        <div class="form-group">
                            <label>å…¶ä»–ä¿¡æ¯</label>
                            <p><strong>æ¨¡å‹ï¼š</strong>${escapeHtml(conv.model)}</p>
                            ${traceIdInfo}
                            <p><strong>æ—¶é—´ï¼š</strong>${formatDate(conv.created_at)}</p>
                        </div>
                    `;

                    document.getElementById('detailModal').classList.add('active');
                    loadConversationRatings(conv.id, conv.prompt ? conv.prompt.id : null);
                } else {
                    showToast(result.message || 'åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        /**
         * å…³é—­å¯¹è¯è¯¦æƒ…Modal
         */
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        /**
         * åŠ è½½åœºæ™¯åç§°åˆ—è¡¨ï¼Œç”¨äºè‡ªåŠ¨å®Œæˆå’Œä¸‹æ‹‰é€‰æ‹©
         */
        async function loadSceneNameList() {
            try {
                // å°è¯•ä»è¯„åˆ†åˆ—è¡¨è·å–ä¸åŒçš„åœºæ™¯åç§°
                const result = await apiGet('/prompt/rating/list?page=1&page_size=100');
                if (result.ok && result.data.list) {
                    // æå–å”¯ä¸€çš„åœºæ™¯åç§°
                    const scenes = [...new Set(result.data.list.map(item => item.scene_name).filter(Boolean))];
                    sceneNameList = scenes;

                    // æ›´æ–°åœºæ™¯ä¸‹æ‹‰é€‰æ‹©æ¡†
                    const sceneSelect = document.getElementById('ratingSceneSelect');
                    if (sceneSelect) {
                        // ä¿ç•™ç¬¬ä¸€ä¸ª"å…¨éƒ¨åœºæ™¯"é€‰é¡¹
                        sceneSelect.innerHTML = '<option value="">å…¨éƒ¨åœºæ™¯</option>';
                        scenes.forEach(scene => {
                            const option = document.createElement('option');
                            option.value = scene;
                            option.textContent = scene;
                            sceneSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load scene names:', error);
            }
        }

        /**
         * è®¾ç½®åœºæ™¯è¾“å…¥æ¡†äº‹ä»¶
         */
        function setupSceneInputEvents() {
            // ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®åˆ—è¡¨
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.scene-input-wrapper')) {
                    hideSuggestions();
                }
            });
        }

        /**
         * æ˜¾ç¤ºåœºæ™¯å»ºè®®åˆ—è¡¨
         */
        function showSceneSuggestions() {
            const suggestions = document.getElementById('sceneSuggestions');
            if (sceneNameList.length > 0) {
                renderSceneSuggestions(sceneNameList);
                suggestions.classList.add('show');
            }
        }

        /**
         * éšè—åœºæ™¯å»ºè®®åˆ—è¡¨
         */
        function hideSuggestions() {
            const suggestions = document.getElementById('sceneSuggestions');
            suggestions.classList.remove('show');
        }

        /**
         * è¿‡æ»¤åœºæ™¯å»ºè®®
         */
        function filterSceneSuggestions() {
            const input = document.getElementById('ratingSceneName');
            const value = input.value.trim().toLowerCase();

            if (!value) {
                renderSceneSuggestions(sceneNameList);
            } else {
                const filtered = sceneNameList.filter(scene =>
                    scene.toLowerCase().includes(value)
                );
                renderSceneSuggestions(filtered);
            }

            const suggestions = document.getElementById('sceneSuggestions');
            suggestions.classList.add('show');
        }

        /**
         * æ¸²æŸ“åœºæ™¯å»ºè®®åˆ—è¡¨
         * @param {Array} scenes - åœºæ™¯åç§°æ•°ç»„
         */
        function renderSceneSuggestions(scenes) {
            const suggestions = document.getElementById('sceneSuggestions');
            if (scenes.length === 0) {
                suggestions.innerHTML = '<div class="scene-suggestion-item" style="color:#999;">æš‚æ— åŒ¹é…åœºæ™¯</div>';
                return;
            }

            suggestions.innerHTML = scenes.map(scene =>
                `<div class="scene-suggestion-item" onclick="selectScene('${escapeJs(scene)}')">${escapeHtml(scene)}</div>`
            ).join('');
        }

        /**
         * é€‰æ‹©åœºæ™¯
         * @param {string} scene - åœºæ™¯åç§°
         */
        function selectScene(scene) {
            document.getElementById('ratingSceneName').value = scene;
            hideSuggestions();
        }
    </script>
</body>
</html>
